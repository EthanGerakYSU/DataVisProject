---
title: "COIVD Visualizatoin Project"
author: "Ethan Gerak"
date: "4/13/2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# devtools::install_github("cmu-delphi/covidcast", ref = "main",
#                          subdir = "R-packages/covidcast")


# devtools::install_github("cmu-delphi/covidcast", ref = "main",
#                          subdir = "R-packages/covidcast",
#                          build_vignettes = TRUE,
#                          dependencies = TRUE)


library(covidcast)
library(dplyr)
library(choroplethrMaps)
library(choroplethr)
library(plotly)
```


```{r test, echo = FALSE}
###https://delphi.cmu.edu/covidcast/export/

cc_data_sep20 <- suppressMessages(
covidcast_signal(data_source = "indicator-combination", signal = "confirmed_incidence_prop",
                 start_day = "2020-09-08", end_day = "2020-09-30",
                 geo_type = "state")
)
cc_data_oct20 <- suppressMessages(
covidcast_signal(data_source = "indicator-combination", signal = "confirmed_incidence_prop",
                 start_day = "2020-10-01", end_day = "2020-10-31",
                 geo_type = "state")
)
cc_data_nov20 <- suppressMessages(
covidcast_signal(data_source = "indicator-combination", signal = "confirmed_incidence_prop",
                 start_day = "2020-11-01", end_day = "2020-11-30",
                 geo_type = "state")
)
cc_data_dec20 <- suppressMessages(
covidcast_signal(data_source = "indicator-combination", signal = "confirmed_incidence_prop",
                 start_day = "2020-12-01", end_day = "2020-12-31",
                 geo_type = "state")
)
cc_data_jan21 <- suppressMessages(
covidcast_signal(data_source = "indicator-combination", signal = "confirmed_incidence_prop",
                 start_day = "2021-01-01", end_day = "2021-01-31",
                 geo_type = "state")
)

cc_data_feb21 <- suppressMessages(
covidcast_signal(data_source = "indicator-combination", signal = "confirmed_incidence_prop",
                 start_day = "2021-02-01", end_day = "2021-02-28",
                 geo_type = "state")
)
cc_data_mar21 <- suppressMessages(
covidcast_signal(data_source = "indicator-combination", signal = "confirmed_incidence_prop",
                 start_day = "2021-03-01", end_day = "2021-03-31",
                 geo_type = "state")
)


# cc_data_jan20 <- suppressMessages(
# covidcast_signal(data_source = "indicator-combination", signal = "confirmed_incidence_prop",
#                  start_day = "2021-01-01", end_day = "2021-01-31",
#                  geo_type = "state")




# plot(cc_data_sep20, choro_col = cm.colors(10), alpha = 0.4,
#      title = "Combination of COVID-19")









#state.name[match(avgCC["region"],state.abb)]

stateFromLower <-function(x) {
   #read 52 state codes into local variable [includes DC (Washington D.C. and PR (Puerto Rico)]
  st.codes<-data.frame(
                      state=as.factor(c("ak", "al", "ar", "az", "ca", "co", "ct", "dc", "de", "fl", "ga",
                                         "hi", "ia", "id", "il", "in", "ks", "ky", "la", "ma", "md", "me",
                                         "mi", "mn", "mo", "ms",  "mt", "nc", "nd", "ne", "nh", "nj", "nm",
                                         "nv", "ny", "oh", "ok", "or", "pa", "pr", "ri", "sc", "sd", "tn",
                                         "tx", "ut", "va", "vt", "wa", "wi", "wv", "wy")),
                      full=as.factor(c("alaska","alabama","arkansas","arizona","california","colorado",
                                       "connecticut","district of columbia","delaware","florida","georgia",
                                       "hawaii","iowa","idaho","illinois","indiana","kansas","kentucky",
                                       "louisiana","massachusetts","maryland","maine","michigan","minnesota",
                                       "missouri","mississippi","montana","north carolina","north dakota",
                                       "nebraska","new hampshire","new jersey","new mexico","nevada",
                                       "new york","ohio","oklahoma","oregon","pennsylvania","puerto rico",
                                       "rhode island","south carolina","south dakota","tennessee","texas",
                                       "utah","virginia","vermont","washington","wisconsin",
                                       "west virginia","wyoming"))
                       )
     #create an nx1 data.frame of state codes from source column
  st.x<-data.frame(state=x)
     #match source codes with codes from 'st.codes' local variable and use to return the full state name
  refac.x<-st.codes$full[match(st.x$state,st.codes$state)]
     #return the full state names in the same order in which they appeared in the original source
  return(refac.x)
 
}

avg = function(data) {
  avgCC = data %>% group_by(geo_value) %>% summarise(avg = mean(value))
   avgCC = avgCC %>% rename(
   region = geo_value,
   value= avg)
}



###Value we are plotting is cases per 100k

#avgCC$region = stateFromLower(avg(cc_data_sep20)$region)



#avgCC$value = avg(cc_data_sep20)$value


#state_choropleth(avgCC)

avg_sep20 = avg(cc_data_sep20)
avg_sep20$region = toupper(avg_sep20$region)
SepCovidGraph <-avg_sep20 %>% 
  plot_geo(locationmode = 'USA-states') %>% 
  add_trace(
    z = ~value, color = ~value, colors = "Greys",
    zmin=0, zmax=110, 
    locations = ~region) %>% 
  layout(geo=list(scope='usa'), title="Average Daily Cases for September")

SepCovidGraph



avg_oct20 = avg(cc_data_oct20)
avg_oct20$region = toupper(avg_oct20$region)

OctCovidGraph <-avg_oct20 %>% 
  plot_geo(locationmode = 'USA-states') %>% 
  add_trace(
    z = ~value, color = ~value, colors = "Greys",
    zmin=0, zmax=110, 
    locations = ~region) %>% 
  layout(geo=list(scope='usa'), title="Average Daily Cases for October")

OctCovidGraph

avg_nov20 = avg(cc_data_nov20)
avg_nov20$region = toupper(avg_nov20$region)
NovCovidGraph <-avg_nov20 %>% 
  plot_geo(locationmode = 'USA-states') %>% 
  add_trace(
    z = ~value, color = ~value, colors = "Greys",
    zmin=0, zmax=110, 
    locations = ~region) %>% 
  layout(geo=list(scope='usa'), title="Average Daily Cases for November")

NovCovidGraph

avg_dec20 = avg(cc_data_dec20)
avg_dec20$region = toupper(avg_dec20$region)
DecCovidGraph <-avg_dec20 %>% 
  plot_geo(locationmode = 'USA-states') %>% 
  add_trace(
    z = ~value, color = ~value, colors = "Greys",
    zmin=0, zmax=110, 
    locations = ~region) %>% 
  layout(geo=list(scope='usa'), title="Average Daily Cases for December")

DecCovidGraph

avg_jan21 = avg(cc_data_jan21)
avg_jan21$region = toupper(avg_jan21$region)
JanCovidGraph <-avg_jan21 %>% 
  plot_geo(locationmode = 'USA-states') %>% 
  add_trace(
    z = ~value, color = ~value, colors = "Greys",
    zmin=0, zmax=110, 
    locations = ~region) %>% 
  layout(geo=list(scope='usa'), title="Average Daily Cases for January")

JanCovidGraph


avg_feb21 = avg(cc_data_feb21)
avg_feb21$region = toupper(avg_feb21$region)
FebCovidGraph <-avg_feb21 %>% 
  plot_geo(locationmode = 'USA-states') %>% 
  add_trace(
    z = ~value, color = ~value, colors = "Greys",
    zmin=0, zmax=110, 
    locations = ~region) %>% 
  layout(geo=list(scope='usa'), title="Average Daily Cases for February")

FebCovidGraph

avg_mar21 = avg(cc_data_mar21)
avg_mar21$region = toupper(avg_mar21$region)
MarCovidGraph <-avg_mar21 %>% 
  plot_geo(locationmode = 'USA-states') %>% 
  add_trace(
    z = ~value, color = ~value, colors = "Greys",
    zmin=0, zmax=110, 
    locations = ~region) %>% 
  layout(geo=list(scope='usa'), title="Average Daily Cases for March")

MarCovidGraph


```


